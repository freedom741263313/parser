# UDP协议解析器 - 原型交互文档 (Prototype Design)

## 1. 设计概述

本文档描述了"跨平台桌面UDP协议解析器"的用户界面(UI)设计和交互流程(UX)。基于PRD文档，旨在提供直观、高效的操作体验。

### 1.1 核心设计理念
- **左侧导航，右侧内容**：采用经典的侧边栏导航布局，确保各功能模块切换便捷。
- **分屏视图**：在解析和调试界面，采用左右或上下分屏，左侧/上方为输入/列表，右侧/下方为详情/结果，便于对照。
- **HexDump风格**：输入和展示紧贴网络工程师习惯，采用HexDump样式。

## 2. 界面导航结构

应用主要分为四个主功能模块，通过左侧侧边栏图标/文字进行切换：

1.  **解析器 (Parser)**：核心功能，静态数据的输入、解析和码流生成。
2.  **UDP调试 (UDP Debugger)**：动态功能，UDP发送、接收、监听和自动响应。
3.  **规则管理 (Rule Manager)**：协议规则的增删改查。
4.  **枚举管理 (Enum Manager)**：枚举字典的维护。

---

## 3. 界面详细设计

### 3.1 解析器 (Parser) 界面

**布局**：
- **顶部工具栏**：
    - **协议选择器**：下拉框，选择当前使用的协议规则。
        - **自定义规则**：例如 `Custom_Proto_V1`。
        - **知名协议**：`STUN`, `SIP`, `DNS`, `DHCP` 等（系统预置）。
    - **模式切换**：单选按钮组 `[解析模式] | [生成模式]`。
- **主内容区**：
    - **左侧（输入区）**：
        - 多行文本框，支持HexDump格式输入。
        - 占位符提示：`45 00 00 1c ...`
        - 实时格式化：用户输入连续字符时，自动每2个字符加空格（可选设置）。
        - 底部按钮：`[清空]` `[解析]`（快捷键 Enter/Cmd+Enter）。
    - **右侧（结果区）**：
        - **树状视图 (Tree View)**：显示解析后的结构化数据。
        - 对于**自定义规则**：显示`[字段名] : [原始Hex] -> [解析值/枚举含义]`。
        - 对于**知名协议**（如SIP）：显示标准化的协议结构，如 `Method: INVITE`, `Via: ...`。
        - 支持展开/折叠嵌套结构。
        - 错误提示：如果解析失败，显示红色错误信息及出错位置。

**交互流程 - 解析模式**：
1.  用户在顶部选择协议规则（例如选择 `SIP`）。
2.  在左侧输入Hex字符串。
3.  点击`[解析]`按钮。
4.  右侧展示按照SIP协议标准解析出的头部和Body信息。

**交互流程 - 生成模式**：
1.  切换到`[生成模式]`。
2.  右侧变为表单输入：根据选定规则列出所有字段输入框。
3.  用户填写各字段值（支持下拉选择枚举值）。
4.  点击`[生成码流]`按钮。
5.  左侧文本框自动填充生成的HexDump字符串。

### 3.2 UDP调试 (UDP Debugger) 界面

**布局**：
- **左侧栏（配置与列表）**：
    - **连接配置**：
        - 本地监听端口输入框。
        - 目标IP & 端口输入框。
        - 按钮：`[开始监听] / [停止]`。
    - **消息列表**：
        - 列表项：`[时间] [方向(发送/接收)] [长度] [源IP:Port]`。
        - 点击某一项，右侧显示详情。
- **右侧栏（详情与操作）**：
    - **顶部页签**：`[消息详情] | [发送/响应配置]`。
    - **消息详情页**：
        - 显示选中消息的HexDump。
        - 显示基于当前规则的解析结果（复用解析器界面的树状视图组件）。
    - **发送/响应配置页**：
        - **手动发送**：输入Hex或使用生成器，点击`[发送]`。
        - **自动响应规则**：
            - 列表显示当前响应逻辑。
            - `[添加响应]` 按钮，弹出配置框：
                - **响应模式**：`自定义规则` 或 `知名协议模拟`。
                - **自定义规则模式**：
                    - **触发条件**：选择字段（如 `CommandID`） == 值（如 `0x01`）。
                    - **响应动作**：选择规则 -> 设置字段值（支持引用 `$Request.Field`）。
                - **知名协议模拟模式**：
                    - **协议选择**：例如 `STUN Server`。
                    - **行为配置**：`[Standard Response]`, `[Error 400]`, `[Reflect Address]` 等预置行为。
                    - 系统自动根据协议规范处理请求并生成响应（计算事务ID、校验和等）。

**交互流程 - 自动响应 (知名协议)**：
1.  用户选择“知名协议模拟”模式，选择 `STUN`。
2.  选择行为 `Standard Response (Binding Success)`。
3.  保存并开启监听。
4.  收到 STUN Binding Request 时，系统自动计算 Mapped Address，生成 Binding Response 并发送。

### 3.3 规则管理 (Rule Manager) 界面

**布局**：
- **左侧**：规则列表（搜索框 + 列表）。底部有 `[新建规则]` `[导入]` `[导出]` 按钮。
- **右侧**：规则编辑器。
    - **基本信息**：规则名称、描述。
    - **字段定义表格**：
        - 列：`字段名`、`偏移(Auto/Fixed)`、`长度`、`类型(Int/String/Byte/Array)`、`端序(BE/LE)`、`解析算法`、`关联枚举`、`操作`。
        - **解析算法**列：下拉选择 `Default`, `LongToIp`, `BCD`, `UTF8`, `HexStr` 等。
        - **关联枚举**列：下拉选择已定义的枚举。
    - **条件分支区域**（高级）：
        - 允许定义：`如果 字段A == X，则下一段解析为 结构体B`。
        - 或者：`根据 字段C 的长度，解析为 IP(4字节) 或 域名(不定长)`。

**交互流程 - 添加规则**：
1.  点击新建，输入名称。
2.  在表格中依次添加字段。
3.  对于状态码字段，在“关联枚举”列选择预先定义的“状态码枚举”。
4.  点击保存。

### 3.4 枚举管理 (Enum Manager) 界面

**布局**：
- **左侧**：枚举字典列表。
- **右侧**：字典详情编辑。
    - 表格：`Hex值` | `中文描述` | `备注`。
    - 支持Excel粘贴或CSV导入。

---

## 4. 关键交互细节

### 4.1 Hex输入体验
- 输入框应当使用等宽字体（Monospace）。
- 支持自动过滤非Hex字符（如 `0x`, `,`, `\n` 等），只保留 `0-9, a-f, A-F`。
- 粘贴 `4500001C` 自动格式化为 `45 00 00 1C`。

### 4.2 错误处理
- **规则解析错误**：如果规则定义读取4字节，但剩余数据只有2字节。
    - 界面表现：解析树中该节点显示红色“数据不足”，后续字段停止解析。
- **网络错误**：UDP端口被占用。
    - 界面表现：顶部Toast提示“监听失败：端口被占用”。

## 5. 视觉风格
- **主题**：支持 深色/浅色 (Dark/Light) 模式，默认跟随系统。
- **配色**：
    - 接收消息：绿色高亮。
    - 发送消息：蓝色高亮。
    - 错误/警告：红色/橙色。
- **字体**：关键数据区域（Hex、代码）使用 `JetBrains Mono` 或 `Consolas`。

